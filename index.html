<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Healyum âš¡</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Chart.js per il grafico stile Polymarket -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg: #020617;
        --bg-card: #020617;
        --accent-up: #22c55e;
        --accent-down: #ef4444;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --border-subtle: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top, #0f172a, #020617 60%);
        color: var(--text-main);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .wrapper {
        width: 100%;
        max-width: 460px;
        padding: 20px 16px;
      }

      .card {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 24px;
        padding: 20px 18px 18px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.18);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .title {
        font-size: 20px;
        font-weight: 700;
      }

      .subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 14px;
      }

      .badge {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge-open {
        border-color: rgba(34, 197, 94, 0.4);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.18);
      }

      .badge-locked {
        border-color: rgba(234, 179, 8, 0.7);
        color: #facc15;
        background: rgba(234, 179, 8, 0.12);
      }

      .badge-resolved {
        border-color: rgba(148, 163, 184, 0.5);
        color: #cbd5f5;
        background: rgba(15, 23, 42, 0.7);
      }

      .market-id {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 14px;
      }

      .pools {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
      }

      .pool {
        flex: 1;
        border-radius: 16px;
        padding: 10px 10px 9px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: radial-gradient(circle at top left, #020617, #020617 60%);
      }

      .pool-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .dot-up,
      .dot-down {
        width: 6px;
        height: 6px;
        border-radius: 50%;
      }

      .dot-up {
        background: var(--accent-up);
      }

      .dot-down {
        background: var(--accent-down);
      }

      .pool-amount {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .pool-perc {
        font-size: 12px;
        color: var(--text-muted);
      }

      .bar-wrapper {
        margin-bottom: 14px;
      }

      .bar-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: #020617;
        border: 1px solid rgba(31, 41, 55, 0.9);
        overflow: hidden;
        display: flex;
      }

      .bar-up {
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #4ade80);
        transition: width 0.25s ease-out;
      }

      .bar-down {
        height: 100%;
        background: linear-gradient(90deg, #ef4444, #fb923c);
        transition: width 0.25s ease-out;
      }

      /* -------- GRAFICO STILE POLYMARKET -------- */
      .chart-wrapper {
        margin-top: 10px;
        margin-bottom: 4px;
      }

      #marketChart {
        width: 100%;
        max-height: 170px;
      }

      .actions {
        display: flex;
        gap: 12px;
        margin-top: 6px;
      }

      button {
        border: none;
        padding: 12px 18px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        flex: 1;
        transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
          opacity 0.15s;
      }

      button:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: none;
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
      }

      .btn-up {
        background: #22c55e;
        color: #022c22;
        box-shadow: 0 6px 18px rgba(34, 197, 94, 0.4);
      }

      .btn-down {
        background: #ef4444;
        color: #450a0a;
        box-shadow: 0 6px 18px rgba(248, 113, 113, 0.35);
      }

      .footer {
        margin-top: 10px;
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-text {
        font-size: 11px;
      }

      .error {
        margin-top: 8px;
        font-size: 11px;
        color: #fca5a5;
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <div class="card">
        <div class="header">
          <div>
            <div class="title">Healyum âš¡</div>
            <div class="subtitle">Predict Tesla: will today close UP or DOWN?</div>
          </div>
          <div id="statusBadge" class="badge badge-open">OPEN</div>
        </div>

        <div id="marketId" class="market-id">Loading marketâ€¦</div>

        <div class="pools">
          <div class="pool">
            <div class="pool-label">
              <span class="dot-up"></span> UP
            </div>
            <div id="upAmount" class="pool-amount">â€“</div>
            <div id="upPerc" class="pool-perc">â€“</div>
          </div>
          <div class="pool">
            <div class="pool-label">
              <span class="dot-down"></span> DOWN
            </div>
            <div id="downAmount" class="pool-amount">â€“</div>
            <div id="downPerc" class="pool-perc">â€“</div>
          </div>
        </div>

        <div class="bar-wrapper">
          <div class="bar-label">Market odds</div>
          <div class="bar">
            <div id="barUp" class="bar-up" style="width: 50%"></div>
            <div id="barDown" class="bar-down" style="width: 50%"></div>
          </div>
        </div>

        <!-- GRAFICO STORICO TIPO POLYMARKET -->
        <div class="chart-wrapper">
          <div class="bar-label">Price over time (UP %)</div>
          <canvas id="marketChart" height="140"></canvas>
        </div>

        <div class="actions">
          <button id="btnUp" class="btn-up" onclick="sendChoice('TESLA_UP')">
            UP ðŸš€
          </button>
          <button id="btnDown" class="btn-down" onclick="sendChoice('TESLA_DOWN')">
            DOWN ðŸ“‰
          </button>
        </div>

        <div class="footer">
          <div class="status-text" id="statusText">Loading live oddsâ€¦</div>
          <div id="updatedAt">â€“</div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
      </div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.ready();
      tg.expand();

      // âš ï¸ dominio pubblico del bot
      const API_BASE = "https://healyum-bot.onrender.com/";

      const els = {
        marketId: document.getElementById("marketId"),
        statusBadge: document.getElementById("statusBadge"),
        statusText: document.getElementById("statusText"),
        upAmount: document.getElementById("upAmount"),
        downAmount: document.getElementById("downAmount"),
        upPerc: document.getElementById("upPerc"),
        downPerc: document.getElementById("downPerc"),
        barUp: document.getElementById("barUp"),
        barDown: document.getElementById("barDown"),
        updatedAt: document.getElementById("updatedAt"),
        btnUp: document.getElementById("btnUp"),
        btnDown: document.getElementById("btnDown"),
        error: document.getElementById("error"),
      };

      function setBadge(status) {
        const s = status.toUpperCase();
        els.statusBadge.className = "badge";
        if (s === "OPEN") {
          els.statusBadge.classList.add("badge-open");
          els.statusBadge.textContent = "OPEN";
        } else if (s === "LOCKED") {
          els.statusBadge.classList.add("badge-locked");
          els.statusBadge.textContent = "LOCKED";
        } else {
          els.statusBadge.classList.add("badge-resolved");
          els.statusBadge.textContent = "RESOLVED";
        }
      }

      function setButtonsEnabled(enabled) {
        els.btnUp.disabled = !enabled;
        els.btnDown.disabled = !enabled;
      }

      // --------- GRAFICO: DATI + INIT ---------
      const MAX_POINTS = 120; // ~30 minuti con refresh ogni 15s

      const marketSeries = {
        labels: [],
        up: [],
        down: [],
      };

      let marketChart = null;

      function initMarketChart() {
        const ctx = document.getElementById("marketChart");
        if (!ctx) return;

        marketChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: marketSeries.labels,
            datasets: [
              {
                label: "UP %",
                data: marketSeries.up,
                borderColor: "#22c55e",
                backgroundColor: "rgba(34,197,94,0.15)",
                tension: 0.35,
                pointRadius: 0,
                borderWidth: 2,
                fill: true,
              },
              {
                label: "DOWN %",
                data: marketSeries.down,
                borderColor: "#ef4444",
                backgroundColor: "rgba(239,68,68,0.08)",
                tension: 0.35,
                pointRadius: 0,
                borderWidth: 1.5,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
                callbacks: {
                  label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`,
                },
              },
            },
            scales: {
              x: {
                ticks: {
                  maxTicksLimit: 5,
                  color: "#9ca3af",
                  font: { size: 10 },
                },
                grid: {
                  display: false,
                },
              },
              y: {
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 25,
                  color: "#6b7280",
                  font: { size: 9 },
                  callback: (v) => v + "%",
                },
                grid: {
                  color: "rgba(31,41,55,0.6)",
                },
              },
            },
          },
        });
      }

      function pushMarketPoint(upPct, downPct) {
        if (!marketChart) return;

        const label = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        marketSeries.labels.push(label);
        marketSeries.up.push(upPct);
        marketSeries.down.push(downPct);

        // tieni solo gli ultimi MAX_POINTS punti
        if (marketSeries.labels.length > MAX_POINTS) {
          marketSeries.labels.shift();
          marketSeries.up.shift();
          marketSeries.down.shift();
        }

        marketChart.update("none");
      }

      // --------- FETCH MERCATO ---------
      async function loadMarket() {
        els.statusText.textContent = "Loading live oddsâ€¦";
        els.error.style.display = "none";

        try {
          const res = await fetch(API_BASE + "market/today", { method: "GET" });

          if (!res.ok) {
            els.statusText.textContent = "Live odds unavailable.";
            els.error.style.display = "block";
            els.error.textContent = `Backend error: HTTP ${res.status} ${res.statusText}`;
            return;
          }

          const m = await res.json();

          if (!m || typeof m !== "object") {
            els.statusText.textContent = "Live odds unavailable.";
            els.error.style.display = "block";
            els.error.textContent = "Backend error: invalid JSON";
            return;
          }

          const up = Number(m.up_pool || 0);
          const down = Number(m.down_pool || 0);
          const total = up + down || 1;

          const upPct = (up / total) * 100;
          const downPct = (down / total) * 100;

          els.marketId.textContent = m.id || "TSLA daily market";
          els.upAmount.textContent = up.toFixed(2);
          els.downAmount.textContent = down.toFixed(2);
          els.upPerc.textContent = upPct.toFixed(1) + "%";
          els.downPerc.textContent = downPct.toFixed(1) + "%";

          els.barUp.style.width = upPct + "%";
          els.barDown.style.width = downPct + "%";

          els.updatedAt.textContent =
            "Updated " + new Date().toLocaleTimeString();

          setBadge(m.status || "OPEN");
          els.statusText.textContent =
            m.status === "OPEN"
              ? "Choose UP or DOWN to join today's pool."
              : "Market is not accepting new bets.";

          setButtonsEnabled(m.status === "OPEN");

          // ðŸ‘‰ aggiorna serie per il grafico
          pushMarketPoint(upPct, downPct);
        } catch (e) {
          els.statusText.textContent = "Live odds unavailable.";
          els.error.style.display = "block";
          els.error.textContent = `Fetch error: ${e.message}`;
        }
      }

      function sendChoice(rawSide) {
        const payload = {
          type: "BET",
          side: rawSide, // "TESLA_UP" | "TESLA_DOWN"
          stake: 1,
        };

        tg.sendData(JSON.stringify(payload));
        tg.close();
      }

      // init grafico + prima fetch + polling
      initMarketChart();
      loadMarket();
      setInterval(loadMarket, 15000);
    </script>
  </body>
</html>
